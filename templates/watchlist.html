{% extends "base.html" %}

{% block title %}Watchlist - Stock Trading System{% endblock %}

{% block content %}
<div x-data="watchlistPage" class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between md:space-x-4 space-y-4 md:space-y-0">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Watchlist</h1>
                    <p class="mt-1 text-sm text-gray-500">Manage symbols by category</p>
                </div>
                <div class="flex items-center space-x-3">
                    <select x-model="activeCategory" @change="loadWatchlist" class="block w-48 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="long_term">Long Term</option>
                        <option value="short_term">Short Term</option>
                        <option value="day_trading">Day Trading</option>
                        <option value="hold">Hold</option>
                    </select>
                    <div class="flex">
                        <input x-model="newSymbol" type="text" placeholder="Add symbol (e.g. RELIANCE)" class="block w-56 border-gray-300 rounded-l-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                        <button @click="addSymbol" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-indigo-600 hover:bg-indigo-700">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Watchlist Table -->
    <div class="bg-white shadow rounded-lg card-shadow overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="symbol in symbols" :key="symbol">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="symbol"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <select :value="activeCategory" @change="changeCategory(symbol, $event.target.value)" class="block w-40 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="long_term">Long Term</option>
                                        <option value="short_term">Short Term</option>
                                        <option value="day_trading">Day Trading</option>
                                        <option value="hold">Hold</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="removeSymbol(symbol)" class="text-red-600 hover:text-red-900">Remove</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <div x-show="symbols.length === 0" class="text-center py-8">
                    <i class="fas fa-list text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">No symbols in this category</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('watchlistPage', () => ({
        activeCategory: 'short_term',
        symbols: [],
        newSymbol: '',

        async init() {
            await this.loadWatchlist();
        },

        async loadWatchlist() {
            try {
                const response = await fetch(`/api/watchlist?category=${this.activeCategory}`);
                if (!response.ok) throw new Error('Failed to load watchlist');
                this.symbols = await response.json();
            } catch (error) {
                console.error('Error loading watchlist:', error);
                showToast('Error loading watchlist', 'error');
            }
        },

        async addSymbol() {
            const symbol = (this.newSymbol || '').trim().toUpperCase();
            if (!symbol) return;
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: [symbol], category: this.activeCategory })
                });
                if (!response.ok) throw new Error('Failed to add symbol');
                this.newSymbol = '';
                await this.loadWatchlist();
                showToast('Symbol added', 'success');
            } catch (error) {
                console.error('Error adding symbol:', error);
                showToast('Error adding symbol', 'error');
            }
        },

        async removeSymbol(symbol) {
            if (!confirm(`Remove ${symbol} from ${this.activeCategory.replace('_', ' ')}?`)) return;
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: [symbol], category: this.activeCategory })
                });
                if (!response.ok) throw new Error('Failed to remove symbol');
                await this.loadWatchlist();
                showToast('Symbol removed', 'success');
            } catch (error) {
                console.error('Error removing symbol:', error);
                showToast('Error removing symbol', 'error');
            }
        },

        async changeCategory(symbol, category) {
            try {
                const params = new URLSearchParams({ symbol, category });
                const response = await fetch(`/api/watchlist/category?${params.toString()}`, { method: 'PUT' });
                if (!response.ok) throw new Error('Failed to change category');
                await this.loadWatchlist();
                showToast('Category updated', 'success');
            } catch (error) {
                console.error('Error changing category:', error);
                showToast('Error changing category', 'error');
            }
        }
    }));
});
</script>
{% endblock %}
