{% extends "base.html" %}

{% block title %}Settings - Stock Trading System{% endblock %}

{% block content %}
<div x-data="settingsPage" class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">System Settings</h1>
                    <p class="mt-1 text-sm text-gray-500">Configure trading parameters and system behavior</p>
                </div>
                <div class="flex space-x-3">
                    <button @click="resetToDefaults" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-undo mr-2"></i>
                        Reset to Defaults
                    </button>
                    <button @click="saveSettings" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-save mr-2"></i>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Settings -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">Trading Configuration</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Auto Trade Toggle -->
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Auto Trade</label>
                        <p class="text-sm text-gray-500">Enable automatic order execution</p>
                    </div>
                    <button @click="settings.auto_trade = !settings.auto_trade" 
                            class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            :class="settings.auto_trade ? 'bg-indigo-600' : 'bg-gray-200'">
                        <span class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"
                              :class="settings.auto_trade ? 'translate-x-5' : 'translate-x-0'"></span>
                    </button>
                </div>

                <!-- Signal Timeout -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Signal Timeout (seconds)</label>
                    <p class="text-sm text-gray-500 mb-2">Time before signals expire</p>
                    <input x-model="settings.signal_timeout" type="number" min="60" max="3600" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Risk Per Trade -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Risk Per Trade (%)</label>
                    <p class="text-sm text-gray-500 mb-2">Maximum risk per individual trade</p>
                    <input x-model="settings.risk_per_trade" type="number" min="0.01" max="0.1" step="0.01" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Max Positions -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Maximum Positions</label>
                    <p class="text-sm text-gray-500 mb-2">Maximum number of open positions</p>
                    <input x-model="settings.max_positions" type="number" min="1" max="50" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Max Daily Loss -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Max Daily Loss (%)</label>
                    <p class="text-sm text-gray-500 mb-2">Daily loss limit before halt</p>
                    <input x-model="settings.max_daily_loss" type="number" min="0.01" max="0.2" step="0.01" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Min Price -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Minimum Price (â‚¹)</label>
                    <p class="text-sm text-gray-500 mb-2">Minimum stock price filter</p>
                    <input x-model="settings.min_price" type="number" min="1" max="1000" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Min Liquidity -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Minimum Liquidity</label>
                    <p class="text-sm text-gray-500 mb-2">Minimum liquidity requirement</p>
                    <input x-model="settings.min_liquidity" type="number" min="10000" max="10000000" step="10000" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Environment -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Environment</label>
                    <p class="text-sm text-gray-500 mb-2">System environment</p>
                    <select x-model="settings.environment" 
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="development">Development</option>
                        <option value="staging">Staging</option>
                        <option value="production">Production</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- System Control -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">System Control</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button @click="haltTrading" 
                        class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                    <i class="fas fa-stop mr-2"></i>
                    Emergency Halt
                </button>
                
                <button @click="resumeTrading" 
                        class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-play mr-2"></i>
                    Resume Trading
                </button>
                
                <button @click="generateReport" 
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-file-pdf mr-2"></i>
                    Generate Report
                </button>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">System Status</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-3" :class="systemStatus.auto_trade ? 'bg-green-400' : 'bg-red-400'"></div>
                    <span class="text-sm text-gray-700">Auto Trade: </span>
                    <span class="text-sm font-medium ml-1" x-text="systemStatus.auto_trade ? 'Enabled' : 'Disabled'"></span>
                </div>
                
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-3" :class="systemStatus.iifl_api_connected ? 'bg-green-400' : 'bg-red-400'"></div>
                    <span class="text-sm text-gray-700">IIFL API: </span>
                    <span class="text-sm font-medium ml-1" x-text="systemStatus.iifl_api_connected ? 'Connected' : 'Disconnected'"></span>
                </div>
                
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-3" :class="systemStatus.database_connected ? 'bg-green-400' : 'bg-red-400'"></div>
                    <span class="text-sm text-gray-700">Database: </span>
                    <span class="text-sm font-medium ml-1" x-text="systemStatus.database_connected ? 'Connected' : 'Disconnected'"></span>
                </div>
                
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-3 bg-blue-400"></div>
                    <span class="text-sm text-gray-700">Environment: </span>
                    <span class="text-sm font-medium ml-1" x-text="systemStatus.environment || 'Unknown'"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('settingsPage', () => ({
        settings: {
            auto_trade: false,
            signal_timeout: 300,
            risk_per_trade: 0.02,
            max_positions: 10,
            max_daily_loss: 0.05,
            min_price: 10.0,
            min_liquidity: 100000,
            environment: 'development'
        },
        systemStatus: {
            auto_trade: false,
            iifl_api_connected: false,
            database_connected: false,
            environment: 'development'
        },
        
        async init() {
            await this.loadSettings();
            await this.loadSystemStatus();
            // Refresh system status every 30 seconds
            setInterval(() => this.loadSystemStatus(), 30000);
        },
        
        async loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                this.settings = { ...this.settings, ...data };
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings', 'error');
            }
        },
        
        async loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                this.systemStatus = {
                    auto_trade: data.auto_trade || false,
                    iifl_api_connected: data.iifl_api_connected || false,
                    database_connected: data.database_connected || false,
                    environment: data.environment || 'unknown'
                };
                
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        },
        
        async saveSettings() {
            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.settings)
                });
                
                if (response.ok) {
                    showToast('Settings saved successfully', 'success');
                    await this.loadSystemStatus(); // Refresh status after save
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Failed to save settings', 'error');
                }
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Error saving settings', 'error');
            }
        },
        
        resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                this.settings = {
                    auto_trade: false,
                    signal_timeout: 300,
                    risk_per_trade: 0.02,
                    max_positions: 10,
                    max_daily_loss: 0.05,
                    min_price: 10.0,
                    min_liquidity: 100000,
                    environment: 'development'
                };
                showToast('Settings reset to defaults', 'info');
            }
        },
        
        async haltTrading() {
            if (confirm('Are you sure you want to halt all trading activities?')) {
                try {
                    const response = await fetch('/api/system/halt', { method: 'POST' });
                    
                    if (response.ok) {
                        showToast('Trading halted successfully', 'warning');
                        await this.loadSystemStatus();
                    } else {
                        showToast('Failed to halt trading', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error halting trading:', error);
                    showToast('Error halting trading', 'error');
                }
            }
        },
        
        async resumeTrading() {
            if (confirm('Are you sure you want to resume trading activities?')) {
                try {
                    const response = await fetch('/api/system/resume', { method: 'POST' });
                    
                    if (response.ok) {
                        showToast('Trading resumed successfully', 'success');
                        await this.loadSystemStatus();
                    } else {
                        showToast('Failed to resume trading', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error resuming trading:', error);
                    showToast('Error resuming trading', 'error');
                }
            }
        },
        
        async generateReport() {
            try {
                const response = await fetch('/api/reports/eod/generate', { method: 'POST' });
                
                if (response.ok) {
                    showToast('Report generation started', 'success');
                } else {
                    showToast('Failed to generate report', 'error');
                }
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Error generating report', 'error');
            }
        }
    }));
});
</script>
{% endblock %}
