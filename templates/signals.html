{% extends "base.html" %}

{% block title %}Signals - Stock Trading System{% endblock %}

{% block content %}
<div x-data="signalsPage" class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg card-shadow">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Trading Signals</h1>
                    <p class="mt-1 text-sm text-gray-500">Manage and approve trading signals</p>
                </div>
                <div class="flex space-x-3">
                    <select x-model="statusFilter" @change="filterSignals" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">All Signals</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="executed">Executed</option>
                        <option value="rejected">Rejected</option>
                        <option value="expired">Expired</option>
                        <option value="failed">Failed</option>
                    </select>
                    <button @click="refreshSignals" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signals Table -->
    <div class="bg-white shadow rounded-lg card-shadow overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SL/TP</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Margin</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="signal in filteredSignals" :key="signal.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900" x-text="signal.symbol"></div>
                                    <div class="text-sm text-gray-500" x-text="signal.reason?.substring(0, 50) + '...'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="getSignalTypeClass(signal.signal_type)">
                                        <i :class="getSignalTypeIcon(signal.signal_type)" class="mr-1"></i>
                                        <span x-text="signal.signal_type.toUpperCase()"></span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div x-text="formatCurrency(signal.price)"></div>
                                    <div class="text-xs text-gray-500" x-text="'Qty: ' + (signal.quantity || 'N/A')"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div x-text="'SL: ' + formatCurrency(signal.stop_loss)"></div>
                                    <div x-text="'TP: ' + formatCurrency(signal.take_profit)"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(signal.margin_required)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="status-badge" :class="getStatusClass(signal.status)" x-text="signal.status.toUpperCase()"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div x-show="signal.status === 'pending'" x-text="getTimeRemaining(signal.expiry_time)"></div>
                                    <div x-show="signal.status !== 'pending'" x-text="formatDateTime(signal.expiry_time)"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div x-show="signal.status === 'pending'" class="flex space-x-2">
                                        <button @click="approveSignal(signal.id)" 
                                                class="text-green-600 hover:text-green-900">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button @click="rejectSignal(signal.id)" 
                                                class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button @click="viewSignalDetails(signal)" 
                                            class="text-indigo-600 hover:text-indigo-900">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <div x-show="filteredSignals.length === 0" class="text-center py-8">
                    <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">No signals found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Details Modal -->
    <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Signal Details</h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div x-show="selectedSignal" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Symbol</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedSignal?.symbol"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Signal Type</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedSignal?.signal_type?.toUpperCase()"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Price</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatCurrency(selectedSignal?.price)"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Quantity</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedSignal?.quantity"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stop Loss</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatCurrency(selectedSignal?.stop_loss)"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Take Profit</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatCurrency(selectedSignal?.take_profit)"></p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Reason</label>
                        <p class="mt-1 text-sm text-gray-900" x-text="selectedSignal?.reason"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <span class="mt-1 status-badge" :class="getStatusClass(selectedSignal?.status)" x-text="selectedSignal?.status?.toUpperCase()"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Margin Required</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatCurrency(selectedSignal?.margin_required)"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Created At</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatDateTime(selectedSignal?.created_at)"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Expiry Time</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatDateTime(selectedSignal?.expiry_time)"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('signalsPage', () => ({
        signals: [],
        filteredSignals: [],
        statusFilter: '',
        showModal: false,
        selectedSignal: null,
        
        async init() {
            await this.loadSignals();
            // Refresh every 15 seconds
            setInterval(() => this.loadSignals(), 15000);
        },
        
        async loadSignals() {
            try {
                const url = this.statusFilter ? `/api/signals?status=${this.statusFilter}` : '/api/signals';
                const response = await fetch(url);
                const data = await response.json();
                
                this.signals = data;
                this.filterSignals();
                
            } catch (error) {
                console.error('Error loading signals:', error);
                showToast('Error loading signals', 'error');
            }
        },
        
        filterSignals() {
            if (this.statusFilter) {
                this.filteredSignals = this.signals.filter(signal => signal.status === this.statusFilter);
            } else {
                this.filteredSignals = this.signals;
            }
        },
        
        async approveSignal(signalId) {
            try {
                const response = await fetch(`/api/signals/${signalId}/approve`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('Signal approved successfully', 'success');
                    await this.loadSignals();
                } else {
                    showToast(result.message || 'Failed to approve signal', 'error');
                }
                
            } catch (error) {
                console.error('Error approving signal:', error);
                showToast('Error approving signal', 'error');
            }
        },
        
        async rejectSignal(signalId) {
            try {
                const response = await fetch(`/api/signals/${signalId}/reject`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('Signal rejected successfully', 'success');
                    await this.loadSignals();
                } else {
                    showToast(result.message || 'Failed to reject signal', 'error');
                }
                
            } catch (error) {
                console.error('Error rejecting signal:', error);
                showToast('Error rejecting signal', 'error');
            }
        },
        
        viewSignalDetails(signal) {
            this.selectedSignal = signal;
            this.showModal = true;
        },
        
        async refreshSignals() {
            await this.loadSignals();
            showToast('Signals refreshed', 'success');
        },
        
        getSignalTypeClass(type) {
            const classes = {
                buy: 'bg-green-100 text-green-800',
                sell: 'bg-red-100 text-red-800',
                exit: 'bg-blue-100 text-blue-800'
            };
            return classes[type] || 'bg-gray-100 text-gray-800';
        },
        
        getSignalTypeIcon(type) {
            const icons = {
                buy: 'fas fa-arrow-up',
                sell: 'fas fa-arrow-down',
                exit: 'fas fa-sign-out-alt'
            };
            return icons[type] || 'fas fa-question';
        },
        
        getStatusClass(status) {
            const classes = {
                pending: 'status-pending',
                approved: 'status-active',
                executed: 'status-executed',
                rejected: 'status-rejected',
                expired: 'status-rejected',
                failed: 'status-rejected'
            };
            return classes[status] || 'status-badge';
        },
        
        getTimeRemaining(expiryTime) {
            if (!expiryTime) return 'N/A';
            
            const now = new Date();
            const expiry = new Date(expiryTime);
            const diff = expiry - now;
            
            if (diff <= 0) return 'Expired';
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            return `${minutes}m ${seconds}s`;
        },
        
        formatCurrency(amount) {
            if (!amount) return 'N/A';
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        },
        
        formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('en-IN');
        }
    }));
});
</script>
{% endblock %}
